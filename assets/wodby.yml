# For more info about Post deployment scripts in Wodby see:
# https://wodby.com/docs/1.0/apps/post-deployment-scripts/
pipeline:
  # Automatically handles drush cr, updb, cim, ...
  - name: "Drush deploy"
    type: command
    command: drush deploy
    directory: $WODBY_APP_ROOT
    only_if: 'drush version --pipe | grep -Eq '^10\.' && [ -n "$(drush st --fields=bootstrap)" ]'
  # Fallback for drush 9 version.
  - name: "Drush deploy (v9)"
    type: command
    command: |
      drush updatedb --no-cache-clear -ny && \
      drush cache:rebuild -ny && \
      drush config:import -ny && \
      drush cache:rebuild -ny
    directory: $WODBY_APP_ROOT
    only_if: 'drush version --pipe | grep -Eq '^9\.' && [ -n "$(drush st --fields=bootstrap)" ]'

  - name: Configure administrator and disable password login for '*@ramsalt.com' accounts.
    type: command
    # TODO Remember this: https://www.drupal.org/project/drupal/issues/540008
    command: |
      drush sqlq 'UPDATE users_field_data SET name="Ramsalt Lab", mail="webmaster@ramsalt.com" WHERE uid = 1 LIMIT 1;' ;
      drush sqlq "UPDATE users_field_data SET pass='#' WHERE mail LIKE '%@ramsalt.com';"
    directory: $WODBY_APP_DOCROOT
    only_if: '[ "$WODBY_ENVIRONMENT_TYPE" = "prod" ] && [ -n "$(drush st --fields=bootstrap)" ]'
